name: Semgrep Scan and Upload to DefectDojo

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

permissions:
  contents: read

jobs:
  semgrep:
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep:1.78.0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: | 
          semgrep \
            --json \
            --output semgrep-results.json \
            --metrics=off \
            --config="p/default"

      - name: Save raw report
        uses: actions/upload-artifact@v4
        with:
          name: raw_report
          path: semgrep-results.json

      - name: Check and Create Organization in DefectDojo
        env:
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          ORG_NAME: "SemmmTest" # Название организации
        run: |
          echo "Checking if organization '${ORG_NAME}' exists in DefectDojo..."

          # Получение ID организации
          ORG_ID=$(curl -s -X GET "${DEFECTDOJO_URL}/api/v2/organizations/" \
            -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
            | jq -r --arg NAME "$ORG_NAME" '.results[] | select(.name == $NAME) | .id')

          if [ -z "$ORG_ID" ]; then
            echo "Organization '${ORG_NAME}' does not exist. Creating it..."

            # Создаем организацию, если она не существует
            CREATE_RESPONSE=$(curl -s -X POST "${DEFECTDOJO_URL}/api/v2/organizations/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"${ORG_NAME}\"}")

            ORG_ID=$(echo $CREATE_RESPONSE | jq -r '.id')

            if [ -z "$ORG_ID" ]; then
              echo "Failed to create organization. Response:"
              echo "$CREATE_RESPONSE"
              exit 1
            else
              echo "Organization '${ORG_NAME}' created successfully with ID: $ORG_ID"
            fi
          else
            echo "Organization '${ORG_NAME}' already exists with ID: $ORG_ID"
          fi
