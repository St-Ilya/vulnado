name: Run Semgrep link test (lolkek)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read   # –Ω—É–∂–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä—è–º–æ–π download-—Å—Å—ã–ª–∫–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Semgrep –±–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: —Å—Ç–∞–≤–∏–º —á–µ—Ä–µ–∑ pipx –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏—é
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip pipx
          pipx install "semgrep==1.140.0"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          semgrep --version

      # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∫—ç—à –ø—Ä–∞–≤–∏–ª Semgrep
      - name: Cache Semgrep rules
        uses: actions/cache@v4
        with:
          path: ~/.cache/semgrep
          key: semgrep-rules-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            semgrep-rules-${{ runner.os }}-

      - name: Run Semgrep
        run: |
          semgrep \
            --gitlab-sast --output semgrep-lolkek.json \
            --metrics=off \
            --config="p/default"

      - name: Upload raw report (semgrep-lolkek.json)
        uses: actions/upload-artifact@v4
        with:
          name: raw_report-lolkek
          path: semgrep-lolkek.json
          retention-days: 14

      # Node.js –¥–ª—è –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ HTML
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create edited JSON (Node)
        run: |
          node - <<'JS'
          const fs = require('fs');
          const src = JSON.parse(fs.readFileSync('semgrep-lolkek.json','utf8'));
          const out = (src.vulnerabilities || []).map(v => ({
            category: v.category,
            description: v.description,
            location: v.location,
            severity: v.severity
          }));
          fs.writeFileSync('semgrep_edited_lolkek.json', JSON.stringify(out, null, 2));
          JS

      - name: Upload edited report (lolkek)
        uses: actions/upload-artifact@v4
        with:
          name: edited_report-lolkek
          path: semgrep_edited_lolkek.json
          retention-days: 14

      - name: Display in the console (lolkek)
        run: cat semgrep_edited_lolkek.json

      - name: Check & build findings (Node, lolkek)
        id: check_s
        shell: bash
        run: |
          node - <<'JS'
          const fs = require('fs');
          const rows = JSON.parse(fs.readFileSync('semgrep_edited_lolkek.json','utf8'));
          const important = rows.filter(r =>
            ['Medium','High','Critical'].includes(String(r.severity||''))
          );
          fs.writeFileSync('findings_lolkek.json', JSON.stringify(important, null, 2));
          const found = important.length > 0 ? 'true' : 'false';
          const msg = important.length === 0 ? 'No Semgrep results found (lolkek)' : 'Semgrep results found (lolkek)';
          // –≤—ã–≤–æ–¥–∏–º –≤ GITHUB_ENV
          fs.appendFileSync(process.env.GITHUB_ENV, `found=${found}\nresultMessage=${msg}\n`);
          // –∏ –≤ GITHUB_OUTPUT ‚Äî –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –Ω–∏–∂–µ
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `count=${important.length}\n`);
          JS

      - name: Upload findings report (lolkek)
        uses: actions/upload-artifact@v4
        with:
          name: findings_report-lolkek
          path: findings_lolkek.json
          retention-days: 14

      # –ö–æ–º–º–µ–Ω—Ç –≤ PR —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–∞—Ö–æ–¥–æ–∫
      - name: Build artifacts page URL
        id: artifact_url
        run: echo "url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}#artifacts" >> "$GITHUB_OUTPUT"

      - name: Comment artifacts page link in PR (lolkek)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
        # v7 —É–∂–µ –¥–∞—ë—Ç github/context –≥–ª–æ–±–∞–ª—å–Ω–æ ‚Äî require –Ω–µ –Ω—É–∂–µ–Ω
          script: |
            const url = `${{ steps.artifact_url.outputs.url }}`;
            const count = `${{ steps.check_s.outputs.count }}`;
            const body = [
              "üß© **Semgrep (lolkek)**",
              "",
              `–ù–∞–π–¥–µ–Ω–æ: **${count}** –≤–∞–∂–Ω—ã—Ö –Ω–∞—Ö–æ–¥–æ–∫ (Medium/High/Critical).`,
              `‚û°Ô∏è [–°–∫–∞—á–∞—Ç—å/–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á—ë—Ç—ã (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤)](${url})`,
              "",
              "_–§–∞–π–ª—ã: `semgrep-lolkek.json`, `semgrep_edited_lolkek.json`, `findings_lolkek.json`_"
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

      # HTML-–æ—Ç—á—ë—Ç (Node) + –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç + –ø—Ä—è–º–∞—è download-—Å—Å—ã–ª–∫–∞ –Ω–∞ ZIP
      - name: Build HTML report (Node, lolkek)
        run: |
          node - <<'JS'
          const fs = require('fs');
          const rows = JSON.parse(fs.readFileSync('semgrep_edited_lolkek.json','utf8'));
          const esc = s => String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
          const tr = r => `
            <tr>
              <td>${esc(r.severity)}</td>
              <td>${esc(r.category)}</td>
              <td>${esc(r.description)}</td>
              <td><code>${esc(r.location?.file||'')}</code>${r.location?.start_line?`:${r.location.start_line}`:''}</td>
            </tr>`;
          const html = `<!doctype html>
          <meta charset="utf-8">
          <title>Semgrep report (lolkek)</title>
          <style>
            body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
            h1{margin:0 0 16px}
            table{border-collapse:collapse;width:100%}
            th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
            th{background:#f7f7f7;text-align:left}
            tr:nth-child(even){background:#fafafa}
          </style>
          <h1>Semgrep report (lolkek)</h1>
          <p>Total: <b>${rows.length}</b></p>
          <table>
            <thead><tr><th>Severity</th><th>Category</th><th>Description</th><th>Location</th></tr></thead>
            <tbody>${rows.map(tr).join('')}</tbody>
          </table>`;
          fs.writeFileSync('semgrep-report-lolkek.html', html);
          JS

      - name: Upload HTML report (lolkek)
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-html-lolkek
          path: semgrep-report-lolkek.html
          retention-days: 14

      - name: Get direct artifact download URL (lolkek)
        id: html_art
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            const art = data.artifacts.find(a => a.name === 'semgrep-html-lolkek');
            if (!art) core.setFailed('Artifact "semgrep-html-lolkek" not found');
            core.setOutput('download_url', art.archive_download_url);

      - name: Comment direct ZIP link in PR (lolkek)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const url = `${{ steps.html_art.outputs.download_url }}`;
            const body = [
              "üß© **Semgrep HTML report (lolkek)**",
              "‚û°Ô∏è [–°–∫–∞—á–∞—Ç—å ZIP —Å –æ—Ç—á—ë—Ç–æ–º (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç)](" + url + ")",
              "",
              "_–í–Ω—É—Ç—Ä–∏: `semgrep-report-lolkek.html`_"
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
